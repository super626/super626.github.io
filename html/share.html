<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/iconfont.css">
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		<style type="text/css">
			.mui-content>.mui-table-view:first-child {
				margin-top: 0px;
			}
		</style>
		<title>分享</title>
	</head>

	<body>
		<div class="mui-content" id="news">
			<ul class="mui-table-view" id="list">
				<li class="mui-table-view-cell mui-media" v-for="item in items">
					<a href="javascript:;">
						<img @tap="play(item)" class="mui-media-object mui-pull-left" src="../img/detail-play.png" />
						<div class="mui-media-body">
							{{item.title}}
							<p class="mui-ellipsis" @tap="play(item)">{{item.content}}

							</p>
							<span class="iconfont icon-jubao mui-pull-right" @tap="jubao(item)"></span>
						</div>
					</a>
				</li>
			</ul>
		</div>

		<script type="text/javascript " src="../js/mui.min.js "></script>
		<script type="text/javascript " src="../js/vue.min.js "></script>
		<script type="text/javascript" src="../js/playerplugin.js"></script>
		<script type="text/javascript" src="../js/update.js" ></script>
		<script>
			var minvideoid = 100000000;
			var maxvideoid = 0;
			var hasOldShares = true;
			var lastTimeStamp = 0; //最后更新时间
			mui.init({
				pullRefresh: {
					container: '#list',
					down: {
						style: 'circle',
						callback: pulldownRefresh
					},
					up: {
						auto: true,
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}

			});

			function play(item) {
				playVideo(item.videourl);
			}

			function jubao(item) {
				mui.openWindow({
					url: 'reportshare.html',
					id: 'reportshare',
					extras: {
						videoid: item.id,
					}
				});

			}

			mui.plusReady(function() {

			});

			var news = new Vue({
				el: '#news',
				data: {
					items: [] //列表信息流数据
				}
			});

			function pullupRefresh() {
				if(!hasOldShares) {
					mui('#list').pullRefresh().endPullup();
					mui.toast('没有更多分享了');
					return;
				}
				var cnt = (minvideoid > maxvideoid ? 10 : 5);
				var data = {
					'baseid': minvideoid,
					'direction': 'older',
					'fetchcount': cnt
				};
				mui.getJSON(getshareurl, data, function(rsp) {
					mui('#list').pullRefresh().endPullup();
					if(rsp && rsp.count > 0) {
						news.items = news.items.concat(convert(rsp.data));
					}
					if(rsp.count < cnt)
						hasOldShares = false;
				});

			}
			
			window.addEventListener('newShare',function(event){  
				lastTimeStamp = 0;
				pulldownRefresh();
			});

			function convert(items) {
				var newItems = [];
				items.forEach(function(item) {
					newItems.push({
						id: item.videoid,
						title: item.title,
						content: item.url,
						videourl: item.url
					});
					if(item.videoid > maxvideoid)
						maxvideoid = item.videoid;
					else if(item.videoid < minvideoid)
						minvideoid = item.videoid;

				});
				return newItems;
			}

			function pulldownRefresh() {
				var timestamp = new Date().getTime();
				if (timestamp - lastTimeStamp < 300000)
				{
					mui('#list').pullRefresh().endPulldown();
					mui.toast('已经是最新分享了');
					return;
				}
				lastTimeStamp = timestamp;
				
				var cnt = (minvideoid > maxvideoid ? 10 : 5);
				var data = {
					'baseid': maxvideoid,
					'direction': 'newer',
					'fetchcount': cnt
				};

				mui.getJSON(getshareurl, data, function(rsp) {
					mui('#list').pullRefresh().endPulldown();
					if(rsp && rsp.count > 0) {
						var newitems = convert(rsp.data);
						for(var i = 0; i < newitems.length; i++) {
							news.items = news.items.unshift(newitems[i]);
						}
					}
				});
			}
		</script>
	</body>

</html>