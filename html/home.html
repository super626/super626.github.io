<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>列表到详情最佳实践</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			.mui-media {
				font-size: 14px;
			}
			
			.mui-table-view .mui-media-object {
				max-width: initial;
				width: 90px;
				height: 70px;
			}
			
			.meta-info {
				position: absolute;
				left: 115px;
				right: 15px;
				bottom: 8px;
				color: #8f8f94;
			}
			
			.meta-info .author,
			.meta-info .time {
				display: inline-block;
			}
			
			.meta-info .time {
				float: right;
			}
			
			.mui-table-view:before,
			.mui-table-view:after {
				height: 0;
			}
			
			.mui-content>.mui-table-view:first-child {
				margin-top: 1px;
			}
			
			.banner {
				height: 180px;
				overflow: hidden;
				position: relative;
				background-position: center;
				background-color: #ccc;
			}
			
			.banner img {
				width: 100%;
				height: auto;
			}
			
			.banner .title {
				position: absolute;
				left: 15px;
				bottom: 15px;
				width: 90%;
				font-size: 16px;
				font-weight: 400;
				line-height: 21px;
				color: black;
				z-index: 11;
			}
		</style>
	</head>

	<body>

		<div class="mui-content" id="news">
			<div id="slider" class="mui-slider" style="height: 200px;">
				<div class="mui-slider-group mui-slider-loop">
					<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
					<div class="mui-slider-item mui-slider-item-duplicate">
						<a href="#">
							<img src="../img/vrdevice.jpg" onclick="bannerImg3Clicked()">
						</a>
					</div>
					<!-- 第一张 -->
					<div class="mui-slider-item">
						<a href="#">
							<img :src="banner.cover" onclick="bannerImg1Clicked()">
						</a>
					</div>
					<!-- 第二张 -->
					<div class="mui-slider-item">
						<a href="#">
							<img src="../img/home_banner1-1.jpg" onclick="bannerImg2Clicked()">
						</a>
					</div>
					<!-- 第三张 -->
					<div class="mui-slider-item">
						<a href="#">
							<img src="../img/vrdevice.jpg" onclick="bannerImg3Clicked()">
						</a>
					</div>
					<!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
					<div class="mui-slider-item mui-slider-item-duplicate">
						<a href="#">
							<img :src="banner.cover" onclick="bannerImg1Clicked()">
						</a>
					</div>
				</div>
				<div class="mui-slider-indicator">
					<div class="mui-indicator mui-active"></div>
					<div class="mui-indicator"></div>
					<div class="mui-indicator"></div>
				</div>
			</div>

			<!--列表信息流 开始-->
			<h2 style='padding: 10px 5px;'>热门电影预告片</h2>
			<ul id="list" class="mui-table-view">
				<li class="mui-table-view-cell mui-media" v-for="item in items">
					<a href="javascript:;" :data-guid="item.guid" @tap="open_detail(item)">
						<img class="mui-media-object mui-pull-left" :src="item.cover">
						<div class="mui-media-body">
							<div class="mui-ellipsis-2">{{item.title}}</div>
						</div>
						<div class="meta-info">
							<div class="time">{{item.time}}</div>
						</div>
					</a>
				</li>
			</ul>
			<!--列表信息流 结束-->
		</div>

		<script src="../js/mui.min.js"></script>
		<script src="../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js"></script>
		<script type="text/javascript">
			var curCity = '北京';
			var curCityId = 290;
			var lastTimeStamp = 0; //最后更新时间
			var webview_detail = null; //详情页webview
			var banneritem = null;

			//mui初始化，配置下拉刷新
			mui.init({
				pullRefresh: {
					container: '#list',
					down: {
						style: 'circle',
						offset: '0px',
						auto: true,
						callback: function() {
							if(window.plus && plus.networkinfo.getCurrentType() === plus.networkinfo.CONNECTION_NONE) {
								plus.nativeUI.toast('似乎已断开与互联网的连接', {
									verticalAlign: 'top'
								});
								return;
							}

							var timestamp = new Date().getTime();
							if(timestamp - lastTimeStamp < 2 * 3600000) {
								mui('#list').pullRefresh().endPulldown();
								mui.toast('已经是最新内容');
								return;
							}
							lastTimeStamp = timestamp;

							mui.ajax('https://api-m.mtime.cn/PageSubArea/HotPlayMovies.api?locationId=' + curCityId, {
								data: {},
								dataType: 'json', //服务器返回json格式数据
								type: 'get', //HTTP请求类型
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									mui('#list').pullRefresh().endPulldown();

									news.items = convertmTimeData(data);
									var check = (localStorage.getItem('check') == 'true' ? true : false);
									

									if(news.items.length > 0) {
										var banneridx = (news.items.length - 1) * Math.random();
										banneridx = Math.floor(banneridx);
										banneritem = news.items[banneridx];
										if (check)
										news.banner = {cover: '../img/videoloading.jpg'};
										else
										news.banner = {
											cover: banneritem.cover
										};
									}

								},
								error: function(xhr, type, errorThrown) {
									news.banner = {
										cover: '../img/videoloading.jpg'
									};

									//异常处理；
									mui.toast("获取数据失败");
									mui('#list').pullRefresh().endPulldown();
								}
							});

						}
					}
				}
			});

			mui.plusReady(function() {

				if(typeof remote_ip_info != "undefined") {
					curCity = remote_ip_info['city'];
					mui.getJSON('../location.json', null, function(data) {
						var arr = data.p;
						for(var i = 0, max = arr.length; i < max; i++) {
							if(arr[i].n == curCity) {
								curCityId = arr[i].id;
								break;
							}
						}
					});
				}

				//预加载详情页
				webview_detail = mui.openWindow({url:'detail.html', id:'detail.html', show:{autoShow:false}, 
				waiting:{autoShow:false}});
			});

			var news = new Vue({
				el: '#news',
				data: {
					banner: {}, //顶部banner数据
					items: [] //列表信息流数据
				}
			});

			/**
			 * 打开新闻详情
			 * 
			 * @param {Object} item 当前点击的新闻对象
			 */
			function open_detail(item) {
				
				//触发子窗口变更新闻详情
				mui.fire(webview_detail, 'get_detail', {
					guid: item.guid,
					title: item.title,
					time: item.time,
					cover: item.cover,
					video: '',
					cityId: curCityId
				});
				setTimeout(function() {
					webview_detail.show("slide-in-right", 300);
				}, 150);
			}

			function convertmTimeData(data) {
				var newItems = [];
				var movies = data.movies;
				var check = (localStorage.getItem('check') == 'true' ? true : false);
				for(var i = 0, max = movies.length; i < max; i++) {
					var item = movies[i];
					if (check)
					item.img = '../img/smallhot.jpg';
					newItems.push({
						guid: item.movieId,
						title: item.titleCn,
						cover: item.img,
						time: item.length + '分钟'
					});
				}
				return newItems;
			}

			function bannerImg1Clicked() {
				if(banneritem != null) {
					open_detail(banneritem);
				}
			}

			function bannerImg3Clicked() {
				plus.runtime.openURL('https://s.taobao.com/search?q=cardboard&js=1&stats_click=search_radio_all%3A1&initiative_id=staobaoz_20171118&ie=utf8', function() {}, function() {});
			}

			function bannerImg2Clicked() {
				mui.openWindow({
					url: 'feipinghelp.html',
					id: 'feipinghelp.html'
				});
			}
		</script>
	</body>

</html>